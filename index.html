<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://egkoppel.github.io/product-sans/google-fonts.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
  </head>
  <body style="background-color:#002560;">
    <h1 id="title" class="product-sans" style="color:white;text-align:center;">Radiator</h1>
    <div id="container">
      <div style="height:85px;">
        <h1 id="name" class="product-sans" style="padding-left:0.5cm;width: 60%; height:100%; float:left; font-family:product-sans;-moz-font-feature-settings: 'liga=1';-ms-font-feature-settings: 'liga';-webkit-font-feature-settings: 'liga';-o-font-feature-settings: 'liga';font-feature-settings: 'liga';">
          Loading...
	  <i id="icon" class="material-icons">refresh</i>
       </h1>

       <h3 id="message" class="product-sans" style="width: 35%; height:100%; float:right; font-family:product-sans;">
         Loading...
       </h3>
     </div>
   </div>
   <script>
	   
// Get a variable from GET
function getQueryVariable(variable) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
    if (pair[0] == variable) {
      var returnValue = pair[1].replace(/%20/g," ");
      return returnValue;
    }
  } 
  // Show error if they haven't put the view name in the URL
  alert('No view specified.\nMake sure you have added ?name=name-of-view on the end of the URL.');
}
	   
// foreach on dictionary
function* entries(obj) {
  for (let key of Object.keys(obj)) {
    yield [key, obj[key]];
  }  
}

// Get the data from Travis (build status and commit message)
function getData(i) {
  var status = 3;
  // Get build status
  $.get( "https://api.travis-ci.org/repos/" + urls[i] + ".json", function( data ) {
    if (data["last_build_status"] != null) {
      status = data["last_build_status"]; // 0 = OK | 1 = Problem | Null = Building
    } else {
      status = 2;
    }
    // Get last commit message
    $.get( "https://api.travis-ci.org/repos/" + urls[i] + "/builds", function( data ) {
      var message = data[0]['message'];
      update(names[i], status, message); // Add to screen
    });
  }).fail(function() { // If the repository doesn't exist
    update(names[i], 3, "Repository does not exist, or is not set up with Travis ðŸ˜ž"); // Add to screen with error message
  });
}
	   
// Add the row to the screen
function update(name, status, message) {
  var color = "";
  var icon = "";
  if (status == 0) {
    // Build OK
    color = "#3ed850"; // Green
    icon = "done"; // Tick
  } else if (status == 1) {
    // Problem with build
    color = "#ff4242"; // Red
    icon = "bug_report"; // Bug
  } else if (status == 2) {
    // Build in progress
    color = "#42b9ff"; // Blue
    icon = "build"; // Spanner
  } else {
    // Not existing
    color = "#9b9b9b"; // Grey
    icon = "priority_high"; // Exclamation mark
  }
  // Add to HTML body
  document.getElementById('container').innerHTML = document.getElementById('container').innerHTML + `<div style="height:85px;background-color:` + color + `;overflow: auto;">
                                                         <h1 class="product-sans" style="padding-left:0.5cm;position: relative;top: 50%;transform: translateY(-50%); width: 60%; height:100%; float:left; font-family:product-sans;-moz-font-feature-settings: 'liga=1';-ms-font-feature-settings: 'liga';-webkit-font-feature-settings: 'liga';-o-font-feature-settings: 'liga';font-feature-settings: 'liga';">
                                                           ` + name + `  <i class="material-icons">` + icon + `</i>
                                                         </h1>

                                                         <h3 class="product-sans" style="position: relative;top: 50%;transform: translateY(-50%); width: 35%; height:100%; float:right; font-family:product-sans;">
                                                           ` + message + `
                                                         </h3>
                                                       </div>`;
}
//----------
// MAIN CODE
var names = [];
var urls = [];
var name = getQueryVariable("name"); // Get the name of the view
document.getElementById('title').innerHTML = name;
$.get( "views/" + name + ".json", function( data ) { // Get the view	
  // Clear the screen
  document.getElementById('container').innerHTML = ""; 
  var i = 0;
  for (let [key, value] of entries(data)) {
    // Store the view names and URLs
    names[i] = key;
    urls[i] = value;
    // Get the data
    getData(i);
    i++;
  }
  // Refresh every 10 seconds
  setInterval(function() {
    // Clear the screen
    document.getElementById('container').innerHTML = "";
    // Get the data
    for (i = 0; i < names.length; i++) {
      getData(i);
    }
  }, 10000);
}).fail(function() {
    // Show error if the view doesn't exist
    alert('The view doesn\'t exist. ðŸ˜ž\nAre you sure it has the right name and has not got the .json extension in the URL?');
});
	   
    </script>
  </body>
</html>
