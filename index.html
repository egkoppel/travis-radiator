<html>
  <head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://egkoppel.github.io/product-sans/google-fonts.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-green.min.css">
    <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
  </head>
  <body style="background-color:#002560;">
      <style>
          .mdl-card {
              margin: 3px;
              display: inline-block;
          }
    .mdl-card__media_grey {
          background-color:#9b9b9b;
      }
      .mdl-card__media_blue {
          background-color:#42b9ff;
      }
      .mdl-card__media_green {
          background-color:#3ed850;
      }
      .mdl-card__media_red {
          background-color:#ff4242;
      }
      .img-circle {
          border-radius: 50%;
      }
      </style>
    <h1 id="title" class="product-sans" style="color:white;text-align:center;font-variant: small-caps;">Radiator</h1>
    <div id="container" class="mdl-grid">
        <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--6-col">
            <div class="mdl-card__media mdl-card__media_grey">
                <div class="mdl-grid">
                    <div class="mdl-cell mdl-cell--2-col photo">
                        <img src="pictures/blank.png" width="100%" border="0"
                            alt="" style="padding:10px;">
                            </div>
                    <div class="mdl-cell mdl-cell--2-col photo">
                        <img src="pictures/blank.png" width="100%" border="0"
                            alt="" style="padding:10px;">
                            </div>
                    <div class="mdl-cell mdl-cell--2-col photo">
                        <img src="pictures/blank.png" width="100%" border="0"
                            alt="" style="padding:10px;">
                            </div>
                    <div class="mdl-cell mdl-cell--2-col photo">
                        <img src="pictures/blank.png" width="100%" border="0"
                            alt="" style="padding:10px;">
                            </div>
                    <div class="mdl-cell mdl-cell--2-col photo">
                        <img src="pictures/blank.png" width="100%" border="0"
                            alt="" style="padding:10px;">
                            </div>
                    
                </div>
                </div>
            <div class="mdl-card__title">
                <h3 class="mdl-card__title-text">Loading...</h3>
            </div>
            <div class="mdl-card__supporting-text">
                Message
            </div>
            <div class="mdl-card__menu">
                    <i class="material-icons">refresh</i>
            </div>
        </div>
   </div>
   <script>
	
	   function imageExists(image_url){

    var http = new XMLHttpRequest();

    http.open('HEAD', image_url, false);
    http.send();

    return http.status != 404;

}
	   
// Get a variable from GET
function getQueryVariable(variable) {
  var query = window.location.search.substring(1);
  var vars = query.split("&");
  for (var i=0;i<vars.length;i++) {
    var pair = vars[i].split("=");
    if (pair[0] == variable) {
      var returnValue = pair[1].replace(/%20/g," ");
      return returnValue;
    }
  } 
  // Show error if they haven't put the view name in the URL
  alert('No view specified.\nMake sure you have added ?name=name-of-view on the end of the URL.');
}
	   
// foreach on dictionary
function* entries(obj) {
  for (let key of Object.keys(obj)) {
    yield [key, obj[key]];
  }  
}

// Get the data from Travis (build status and commit message)
function getData(i) {
  var status = 3;
  // Get build status
  $.get( "https://api.travis-ci.org/repos/" + urls[i] + ".json", function( data ) {
    if (data["last_build_status"] != null) {
      status = data["last_build_status"]; // 0 = OK | 1 = Problem | Null = Building
    } else {
      status = 2;
    }
    // Get last commit message
    $.get( "https://api.travis-ci.org/repos/" + urls[i] + "/builds", function( data ) {
      var message = data[0]['message'];
      var users = message.substr(0,message.indexOf(':'));
          users = users.split("/");
      message = message.substr(message.indexOf(':')+1);
      update(names[i], status, message, users); // Add to screen
    });
  }).fail(function() { // If the repository doesn't exist
    update(names[i], 3, "Repository does not exist, or is not set up with Travis ðŸ˜ž"); // Add to screen with error message
  });
}
	   
// Add the row to the screen
function update(name, status, message, users) {
  var color = "";
  var icon = "";
  var statusText = "";
  if (status == 0) {
    // Build OK
    color = "green"; // Green
    icon = "done"; // Tick
    statusText = "OK";
  } else if (status == 1) {
    // Problem with build
    color = "red"; // Red
    icon = "bug_report"; // Bug
    statusText = "There is a bug";
  } else if (status == 2) {
    // Build in progress
    color = "blue"; // Blue
    icon = "build"; // Spanner
    statusText = "Building";
  } else {
    // Not existing
    color = "grey"; // Grey
    icon = "priority_high"; // Exclamation mark
    statusText = "Error";
  }
  console.log(users.length);
  var images = ``;
  if (users.length > 5) {
      users[4] = "more";
  }
  if (users.length == 0) {
      users[0] = "none";
  }
  for (index = 0; index < 5; ++index) {
      if ( users[index] !== undefined ) {
          // index doesn't point to an undefined item.]
          console.log(users[index]);
          images = images + `<div class="mdl-cell mdl-cell--2-col"><img class="img-circle" src="pictures/` + users[index] + `.png" width="100%" border="0"
          alt="" style="padding:10px;">
          </div>`
      }
  }
  // Add to HTML body
  document.getElementById('container').innerHTML = document.getElementById('container').innerHTML + `<div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--6-col">
  <div class="mdl-card__media mdl-card__media_grey">
  <div class="mdl-grid">
  ` + images + `
  </div>
  </div>
  <div class="mdl-card__title">
  <h3 class="mdl-card__title-text">` + name + `</h3>
  </div>
  <div class="mdl-card__supporting-text">
  ` + message + `
  </div>
  <div class="mdl-card__menu">
  <i class="material-icons">` + icon + `</i>
  </div>
  </div>
`;
}
//----------
// MAIN CODE
var names = [];
var urls = [];
var name = getQueryVariable("name"); // Get the name of the view
document.getElementById('title').innerHTML = name;
$.get( "views/" + name + ".json", function( data ) { // Get the view
  // Clear the screen
  document.getElementById('container').innerHTML = "";
  var i = 0;
  for (let [key, value] of entries(data)) {
    // Store the view names and URLs
    names[i] = key;
    urls[i] = value;
    // Get the data
    getData(i);
    i++;
  }
  // Refresh every 10 seconds
  setInterval(function() {
    // Clear the screen
    document.getElementById('container').innerHTML = "";
    // Get the data
    for (i = 0; i < names.length; i++) {
      getData(i);
    }
  }, 10000);
}).fail(function() {
    // Show error if the view doesn't exist
    alert('The view doesn\'t exist. ðŸ˜ž\nAre you sure it has the right name and has not got the .json extension in the URL?');
});

    </script>
  </body>
</html>
